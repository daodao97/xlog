<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <title>xlog 配置管理</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      margin: 0;
      min-height: 100vh;
      background: #0f172a;
      color: #e2e8f0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .card {
      width: min(640px, 100%);
      background: #1e293b;
      border: 1px solid #334155;
      border-radius: 12px;
      padding: 28px;
      box-shadow: 0 20px 40px rgba(15, 23, 42, 0.4);
    }
    h1 {
      margin: 0 0 12px;
      font-size: 22px;
      color: #f8fafc;
    }
    p {
      margin: 0 0 16px;
      font-size: 14px;
      color: #cbd5f5;
      line-height: 1.6;
    }
    textarea {
      width: 100%;
      min-height: 180px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #475569;
      background: #0f172a;
      color: #f8fafc;
      font-size: 14px;
      font-family: "JetBrains Mono", "SFMono-Regular", monospace;
      resize: vertical;
    }
    .actions {
      display: flex;
      gap: 12px;
      margin-top: 16px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 14px;
    }
    .btn-compact {
      padding: 6px 10px;
      font-size: 12px;
    }
    .btn-primary {
      background: #2563eb;
      color: #f8fafc;
    }
    .btn-primary:hover {
      background: #1d4ed8;
    }
    .btn-secondary {
      background: #1e293b;
      border: 1px solid #334155;
      color: #e2e8f0;
    }
    .btn-secondary:hover {
      background: #2563eb;
      color: #fff;
    }
    .message {
      margin-top: 12px;
      font-size: 13px;
      min-height: 18px;
      color: #93c5fd;
    }
    .message.error {
      color: #f87171;
    }
    .cleanup-actions {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 8px;
    }
    .cleanup-shortcuts {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: #94a3b8;
    }
    .cleanup-shortcuts span {
      color: #cbd5f5;
    }
    .cleanup-custom {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .cleanup-custom input {
      background: #0f172a;
      border: 1px solid #475569;
      border-radius: 6px;
      padding: 6px 8px;
      color: #f8fafc;
      font-size: 12px;
    }
    .cleanup-custom input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px #2563eb44;
    }
  </style>
</head>
<body>
  <div class="card" style="max-width: 960px; width: 100%;">
    <h1>容器白名单与统计</h1>
    <p>输入允许采集的容器名称正则表达式（每行一条，支持 Go 正则语法）。留空表示采集所有容器。</p>
    <textarea id="patterns" placeholder="例如：
^important-service$
^prod-.*"></textarea>
    <div class="actions">
      <button type="button" class="btn-primary" id="save-btn">保存配置</button>
      <button type="button" class="btn-secondary" id="cancel-btn">放弃修改</button>
      <a href="/" class="btn-secondary" style="text-decoration:none;display:inline-flex;align-items:center;">返回首页</a>
    </div>
    <div class="message" id="message"></div>

    <h2 style="margin-top:24px;font-size:18px;color:#f8fafc;">容器统计</h2>
    <p style="margin-top:4px;">下表展示当前采集的容器、日志数量、估算占用以及时间范围。点击“清理日志”可删除该容器的全部历史记录。</p>
    <div class="table-wrapper" style="overflow-x:auto; margin-top:12px;">
      <table id="stats-table" style="width:100%; border-collapse: collapse; background:#111827; border-radius:8px; overflow:hidden;">
        <thead>
          <tr style="background:#1e293b; text-align:left;">
            <th style="padding:8px 12px;">容器</th>
            <th style="padding:8px 12px;">日志条数</th>
            <th style="padding:8px 12px;">估算占用</th>
            <th style="padding:8px 12px;">时间范围</th>
            <th style="padding:8px 12px;">操作</th>
          </tr>
        </thead>
        <tbody id="stats-body">
          <tr>
            <td colspan="5" style="padding:12px; text-align:center; color:#94a3b8;">加载中…</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    const textarea = document.getElementById('patterns');
    const saveBtn = document.getElementById('save-btn');
    const cancelBtn = document.getElementById('cancel-btn');
    const messageEl = document.getElementById('message');
    const numberFormatter = new Intl.NumberFormat('zh-CN');

    function redirectToVerify() {
      window.location.href = '/verify';
    }

    const statsBody = document.getElementById('stats-body');

    async function fetchConfig() {
      messageEl.textContent = '';
      messageEl.classList.remove('error');
      try {
        const res = await fetch('/api/config');
        if (res.status === 401) {
          redirectToVerify();
          return;
        }
        if (!res.ok) {
          throw new Error(await res.text());
        }
        const data = await res.json();
        textarea.value = (data.allowPatterns || []).join('\n');
      } catch (err) {
        messageEl.textContent = '加载失败：' + err.message;
        messageEl.classList.add('error');
      }
    }

    async function fetchStats() {
      statsBody.innerHTML = '<tr><td colspan="5" style="padding:12px; text-align:center; color:#94a3b8;">加载中…</td></tr>';
      try {
        const res = await fetch('/api/containers/stats');
        if (res.status === 401) {
          redirectToVerify();
          return;
        }
        if (!res.ok) {
          throw new Error(await res.text());
        }
        const data = await res.json();
        renderStats(Array.isArray(data) ? data : []);
      } catch (err) {
        statsBody.innerHTML = '<tr><td colspan="5" style="padding:12px; text-align:center; color:#f87171;">加载失败：' + err.message + '</td></tr>';
      }
    }

    function renderStats(stats) {
      if (stats.length === 0) {
        statsBody.innerHTML = '<tr><td colspan="5" style="padding:12px; text-align:center; color:#94a3b8;">暂无数据</td></tr>';
        return;
      }
      statsBody.innerHTML = '';
      stats.forEach(stat => {
        const name = stat.containerName || '';
        const displayName = name || '(未命名)';
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="padding:8px 12px; border-bottom:1px solid #1f2937;">${escapeHtml(displayName)}</td>
          <td style="padding:8px 12px; border-bottom:1px solid #1f2937;">${formatNumber(stat.logCount)}</td>
          <td style="padding:8px 12px; border-bottom:1px solid #1f2937;">${formatBytes(stat.messageBytes)}</td>
          <td style="padding:8px 12px; border-bottom:1px solid #1f2937;">${formatRange(stat.firstTimestamp, stat.lastTimestamp)}</td>
          <td style="padding:8px 12px; border-bottom:1px solid #1f2937;">
            <div class="cleanup-actions">
              <button type="button" class="btn-secondary"
                data-action="cleanup-all"
                data-name="${escapeAttr(name)}"
                data-display="${escapeAttr(displayName)}"
                data-count="${stat.logCount || 0}"
                data-bytes="${stat.messageBytes || 0}">清理全部</button>
              <div class="cleanup-shortcuts">
                <span>按日期:</span>
                <button type="button" class="btn-secondary btn-compact"
                  data-action="cleanup-days"
                  data-days="1"
                  data-name="${escapeAttr(name)}"
                  data-display="${escapeAttr(displayName)}">一天前</button>
                <button type="button" class="btn-secondary btn-compact"
                  data-action="cleanup-days"
                  data-days="2"
                  data-name="${escapeAttr(name)}"
                  data-display="${escapeAttr(displayName)}">两天前</button>
                <button type="button" class="btn-secondary btn-compact"
                  data-action="cleanup-days"
                  data-days="7"
                  data-name="${escapeAttr(name)}"
                  data-display="${escapeAttr(displayName)}">七天前</button>
                <div class="cleanup-custom">
                  <input type="datetime-local"
                    class="cleanup-input"
                    data-name="${escapeAttr(name)}"
                    data-display="${escapeAttr(displayName)}"
                    aria-label="选择要清理的截止时间" />
                  <button type="button" class="btn-secondary btn-compact"
                    data-action="cleanup-date"
                    data-name="${escapeAttr(name)}"
                    data-display="${escapeAttr(displayName)}">按日期执行</button>
                </div>
              </div>
            </div>
          </td>
        `;
        statsBody.appendChild(tr);
      });
      statsBody.querySelectorAll('button[data-action="cleanup-all"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const name = btn.getAttribute('data-name') || '';
          const display = btn.getAttribute('data-display') || name || '(未命名)';
          const logCount = parseInt(btn.getAttribute('data-count') || '0', 10);
          const sizeBytes = parseInt(btn.getAttribute('data-bytes') || '0', 10);

          cleanupContainer({
            name,
            displayName: display,
            mode: 'all',
            logCount: Number.isFinite(logCount) ? logCount : 0,
            sizeBytes: Number.isFinite(sizeBytes) ? sizeBytes : 0
          });
        });
      });

      statsBody.querySelectorAll('button[data-action="cleanup-days"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const name = btn.getAttribute('data-name') || '';
          const display = btn.getAttribute('data-display') || name || '(未命名)';
          const days = parseInt(btn.getAttribute('data-days') || '0', 10);
          if (!Number.isFinite(days) || days <= 0) {
            messageEl.textContent = '无效的快捷时间选项。';
            messageEl.classList.add('error');
            return;
          }
          const cutoffDate = new Date(Date.now() - days * 24 * 60 * 60 * 1000);
          const humanLabel = `${days === 1 ? '1 天前' : days + ' 天前'}（${formatTime(cutoffDate)}）`;

          cleanupContainer({
            name,
            displayName: display,
            mode: 'before',
            cutoffISO: cutoffDate.toISOString(),
            cutoffLabel: humanLabel
          });
        });
      });

      statsBody.querySelectorAll('button[data-action="cleanup-date"]').forEach(btn => {
        btn.addEventListener('click', () => {
          const name = btn.getAttribute('data-name') || '';
          const display = btn.getAttribute('data-display') || name || '(未命名)';
          const container = btn.closest('.cleanup-custom');
          const input = container ? container.querySelector('input[type="datetime-local"]') : null;
          if (!input || !input.value) {
            messageEl.textContent = '请选择要清理的截止时间。';
            messageEl.classList.add('error');
            return;
          }
          const cutoffDate = new Date(input.value);
          if (Number.isNaN(cutoffDate.getTime())) {
            messageEl.textContent = '截止时间格式无效。';
            messageEl.classList.add('error');
            return;
          }
          cleanupContainer({
            name,
            displayName: display,
            mode: 'before',
            cutoffISO: cutoffDate.toISOString(),
            cutoffLabel: formatTime(cutoffDate)
          });
        });
      });
    }

    function collectPatterns() {
      return textarea.value
        .split(/\r?\n/)
        .map(line => line.trim())
        .filter(line => line.length > 0);
    }

    saveBtn.addEventListener('click', async () => {
      const patterns = collectPatterns();
      messageEl.textContent = '保存中…';
      messageEl.classList.remove('error');
      try {
        const res = await fetch('/api/config', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ allowPatterns: patterns })
        });
        if (res.status === 401) {
          redirectToVerify();
          return;
        }
        if (!res.ok) {
          throw new Error(await res.text());
        }
        messageEl.textContent = '保存成功，配置已更新。';
        messageEl.classList.remove('error');
        fetchStats();
      } catch (err) {
        messageEl.textContent = '保存失败：' + err.message;
        messageEl.classList.add('error');
      }
    });

    cancelBtn.addEventListener('click', () => {
      fetchConfig();
    });

    async function cleanupContainer(options) {
      const {
        name,
        displayName,
        logCount = 0,
        sizeBytes = 0,
        mode = 'all',
        cutoffISO,
        cutoffLabel
      } = options || {};

      const normalizedName = (name || '').trim();
      const display = displayName || normalizedName || '(未命名)';
      if (!normalizedName) {
        messageEl.textContent = '容器名称无效，无法执行清理。';
        messageEl.classList.add('error');
        return;
      }

      let readableCutoff = cutoffLabel;
      if (mode === 'before') {
        if (!cutoffISO) {
          messageEl.textContent = '请选择有效的截止时间。';
          messageEl.classList.add('error');
          return;
        }
        readableCutoff = readableCutoff || formatTime(cutoffISO);
      }

      let confirmMsg = '';
      if (mode === 'before') {
        confirmMsg = `确定清理容器 "${display}" 在 ${readableCutoff} 之前的日志吗？\n\n` +
          `⚠️ 警告：\n` +
          `• 删除操作不可撤销\n` +
          `• 本次仅删除早于指定时间的日志\n` +
          `• 删除过程中请勿关闭浏览器`;
      } else {
        const estimatedSeconds = Math.ceil(logCount / 3000);
        const estimatedTime = estimatedSeconds < 60
          ? estimatedSeconds + ' 秒'
          : Math.ceil(estimatedSeconds / 60) + ' 分钟';

        confirmMsg = `确定清理容器 "${display}" 的全部日志吗？\n\n` +
          `日志数量: ${formatNumber(logCount)}\n` +
          `占用空间: ${formatBytes(sizeBytes)}\n` +
          `预计耗时: 约 ${estimatedTime}\n\n` +
          `⚠️  警告：\n` +
          `• 删除操作不可撤销\n` +
          `• 大量数据删除可能需要较长时间\n` +
          `• 删除过程中请勿关闭浏览器`;
      }

      if (!confirm(confirmMsg)) {
        return;
      }

      if (mode === 'before') {
        messageEl.textContent = `正在清理容器 "${display}" 在 ${readableCutoff} 之前的日志，请稍候…`;
      } else {
        messageEl.textContent = `正在清理容器 "${display}" 的日志，请稍候…`;
      }
      messageEl.classList.remove('error');

      const allButtons = document.querySelectorAll('button[data-name]');
      allButtons.forEach(btn => btn.disabled = true);

      try {
        const payload = { containerName: normalizedName };
        if (mode === 'before') {
          payload.before = cutoffISO;
        }

        const res = await fetch('/api/containers/cleanup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (res.status === 401) {
          redirectToVerify();
          return;
        }
        if (!res.ok) {
          throw new Error(await res.text());
        }

        const result = await res.json();
        const deletedCount = result.deleted || 0;
        if (mode === 'before') {
          messageEl.textContent = `✓ 已清理容器 "${display}" 在 ${readableCutoff} 之前的 ${formatNumber(deletedCount)} 条日志。`;
        } else {
          messageEl.textContent = `✓ 已清理容器 "${display}" 的 ${formatNumber(deletedCount)} 条日志，空间已回收。`;
        }
        messageEl.classList.remove('error');
        fetchStats();
      } catch (err) {
        messageEl.textContent = '清理失败：' + err.message;
        messageEl.classList.add('error');
      } finally {
        allButtons.forEach(btn => btn.disabled = false);
      }
    }

    function escapeHtml(text) {
      return String(text ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    function escapeAttr(text) {
      return String(text ?? '')
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function formatNumber(value) {
      return numberFormatter.format(value ?? 0);
    }

    function formatBytes(bytes) {
      if (typeof bytes !== 'number' || !Number.isFinite(bytes) || bytes <= 0) {
        return '0 B';
      }
      const units = ['B', 'KB', 'MB', 'GB', 'TB'];
      let size = bytes;
      let idx = 0;
      while (size >= 1024 && idx < units.length - 1) {
        size /= 1024;
        idx++;
      }
      const precision = idx === 0 ? 0 : 1;
      return size.toFixed(precision) + ' ' + units[idx];
    }

    function formatRange(first, last) {
      if (!first && !last) {
        return '-';
      }
      const firstText = formatTime(first);
      const lastText = formatTime(last);
      return firstText + ' ~ ' + lastText;
    }

    function formatTime(value) {
      if (!value) return '-';
      const date = new Date(value);
      if (Number.isNaN(date.getTime()) || date.getFullYear() <= 1) {
        return '-';
      }
      return date.toLocaleString();
    }

    fetchConfig();
    fetchStats();
  </script>
</body>
</html>
